import subprocess
import time
import os

# Function to execute a command and print its output
def run_command(command):
    print(f"Running command: {command}")
    output = subprocess.run(command, capture_output=True, text=True, shell=True)
    print(f"Command output:\n{output.stdout.strip()}\n")
    return output.stdout.strip()

class R2D2Step:
    step = "Velero Test"

    def __init__(self, repo, repo1, console, config):
        self.repo = repo
        self.repo1 = repo1
        self.console = console
        self.config = config

    def run(self):
        self.console.info("Running Velero tests...")
        # Command 1: kubectl apply
        run_command("kubectl apply -f ./r2d2/templates/velero_test.yaml")

        # Wait for 60 seconds
        time.sleep(60)

        # Command 2: Get Velero pod name
        veleropod_command = "kubectl get pod -n velero-test -o json | jq -r '.items[].metadata.name'"
        veleropod = subprocess.check_output(veleropod_command, shell=True, text=True).strip()

        # Command 3: kubectl exec and tail log
        log_command = f"kubectl exec {veleropod} -n velero-test -- tail /mnt/velero-test/test.log"
        run_command(log_command)

        # Command 4: Create Velero backup
        backup_command = f"velero backup create velero-test-backup-${{VERSION}} -l app=velero-test"
        run_command(backup_command)

        # command 5: Wait for 60 seconds
        time.sleep(60)

        # Command 6: Get Velero backups
        get_backup_command = "velero backup get"
        run_command(get_backup_command)

        # Command 7: kubectl delete
        delete_command = "kubectl delete -f ./r2d2/templates/velero_test.yaml"
        run_command(delete_command)

        # command 8: Wait for 60 seconds
        time.sleep(60)

        # Command 9: Create Velero restore
        restore_command = f"velero restore create velero-test-restore-${{VERSION}} --from-backup velero-test-backup-${{VERSION}}"
        run_command(restore_command)

        # command 10: Wait for 60 seconds
        time.sleep(60)

        # Command 11: kubectl exec and cat log
        log_command = f"kubectl exec {veleropod} -n velero-test -- cat /mnt/velero-test/test.log"
        run_command(log_command)

        # Command 12: kubectl delete
        delete_command = "kubectl delete -f ./r2d2/templates/velero_test.yaml"
        run_command(delete_command)

