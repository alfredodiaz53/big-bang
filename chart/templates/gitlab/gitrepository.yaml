{{- if (not .Values.offline) }}
{{- $name := "gitlab" }}
{{- $namespace := .Release.Namespace }}
{{- $fluxinterval := .Values.flux.interval }}
{{- $outerscope := . }}
{{- with .Values.addons.gitlab -}}
{{- if and (eq .sourceType "git") .enabled }}
apiVersion: source.toolkit.fluxcd.io/v1
kind: GitRepository
metadata:
  name: {{ $name }}
  namespace: {{ $namespace }}
  labels:
    app.kubernetes.io/name: {{ $name }}
    app.kubernetes.io/component: "developer-tools"
    {{- include "commonLabels" $outerscope | nindent 4}}
spec:
  interval: {{ $fluxinterval }}
  url: {{ .git.repo }}
  ref:
    {{- include "validRef" .git | nindent 4 }}
  {{- if .git.existingSecret }}
  secretRef:
    name: {{ .git.existingSecret }}
  {{- else if .git.credentials }}
  secretRef:
    name: {{ $.Release.Name }}-{{ $name }}-git-credentials
  {{- else }}
  {{- include "gitCreds" $outerscope | nindent 2 }}
  {{- end }}
{{- end }}
{{- end }}
{{- end }}
